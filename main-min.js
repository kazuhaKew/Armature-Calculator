document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("themeToggleBtn"),t=localStorage.getItem("theme")||"light";function n(){const t="light"===document.documentElement.getAttribute("data-theme")?"dark":"light";document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t),e.setAttribute("aria-checked","dark"===t)}document.documentElement.setAttribute("data-theme",t),e.setAttribute("aria-checked","dark"===t),document.addEventListener("keydown",function(e){"D"===e.key&&e.shiftKey&&n()}),e.addEventListener("click",n);let d=null;const o=document.getElementById("calculateBtn"),r=document.getElementById("saveBtn");o.textContent="–û—á–∏—Å—Ç–∏—Ç—å",o.addEventListener("click",function(){d?(d=null,c(),o.textContent="–û—á–∏—Å—Ç–∏—Ç—å",r.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"):c()}),r.addEventListener("click",function(){const e=document.getElementById("rebarName").value,t=parseFloat(document.getElementById("rebarLength").value),n=parseFloat(document.getElementById("segmentLength").value),i=parseInt(document.getElementById("quantity").value),m=parseInt(document.getElementById("segments").textContent),s=parseFloat(document.getElementById("remainder").textContent);if(!(e&&t&&n&&i))return void alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");if(0===m)return void alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞");const u={id:d||Date.now(),name:e,length:t,segment:n,quantity:i,segments:m,remainder:s,totalRemainder:s*i,date:d&&a.find(e=>e.id===d)?.date||(new Date).toLocaleString("ru-RU")};if(d){const e=a.findIndex(e=>e.id===d);-1!==e&&(a[e]=u),d=null,o.textContent="–û—á–∏—Å—Ç–∏—Ç—å",r.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}else a.push(u);localStorage.setItem("savedRecords",JSON.stringify(a)),l(),c(),document.querySelector(".table-container").scrollIntoView({behavior:"smooth"})}),document.getElementById("rebarLength").addEventListener("input",i),document.getElementById("segmentLength").addEventListener("input",i),document.getElementById("quantity").addEventListener("input",i);let a=JSON.parse(localStorage.getItem("savedRecords"))||[];function c(){document.getElementById("rebarName").value="",document.getElementById("rebarLength").value="1750",document.getElementById("segmentLength").value="",document.getElementById("quantity").value="1",document.getElementById("segments").textContent="0",document.getElementById("remainder").textContent="0",document.getElementById("totalRemainder").textContent="0"}function i(){const e=parseFloat(document.getElementById("rebarLength").value)||0,t=parseFloat(document.getElementById("segmentLength").value)||0,n=parseInt(document.getElementById("quantity").value)||0;if(e<=0||t<=0||n<=0)return document.getElementById("segments").textContent="0",document.getElementById("remainder").textContent="0",void(document.getElementById("totalRemainder").textContent="0");const d=Math.floor(e/t),o=e%t,r=o*n;document.getElementById("segments").textContent=d,document.getElementById("remainder").textContent=o,document.getElementById("totalRemainder").textContent=r}function l(){const e=document.getElementById("recordsBody");if(e.innerHTML="",0===a.length){const t=document.createElement("tr");return t.innerHTML='<td colspan="8" class="empty-records">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤</td>',void e.appendChild(t)}a.forEach((t,n)=>{const d=document.createElement("tr");var o,r;d.classList.add("record-row"),d.dataset.recordId=t.id,n===a.length-1&&a.length>1&&d.classList.add("new-record"),d.innerHTML=`\n                <td title="${t.name}">${o=t.name,r=20,o.length>r?o.substring(0,r)+"...":o}</td>\n                <td>${t.length}</td>\n                <td>${t.segment}</td>\n                <td>${t.quantity}</td>\n                <td>${t.segments}</td>\n                <td>${t.remainder}</td>\n                <td title="${t.date}">${t.date}</td>\n                <td>\n                    <button class="action-btn edit-btn" data-id="${t.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>\n                    <button class="action-btn delete-btn" data-id="${t.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>\n                </td>\n            `,e.appendChild(d)}),document.querySelectorAll(".edit-btn").forEach(e=>{e.addEventListener("click",u)}),document.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",g)})}l(),document.getElementById("sortByNameBtn").addEventListener("click",()=>s("name")),document.getElementById("sortByLengthBtn").addEventListener("click",()=>s("length")),document.getElementById("sortBySegmentBtn").addEventListener("click",()=>s("segment")),document.getElementById("sortByQuantityBtn").addEventListener("click",()=>s("quantity")),document.getElementById("sortBySegmentsBtn").addEventListener("click",()=>s("segments")),document.getElementById("sortByRemainderBtn").addEventListener("click",()=>s("remainder")),document.getElementById("sortByDateBtn").addEventListener("click",()=>s("date")),document.getElementById("exportBtn").addEventListener("click",function(){if(0===a.length)return void alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");const e=JSON.stringify(a,null,2),t="data:application/json;charset=utf-8,"+encodeURIComponent(e),n=`armature_data_${(new Date).toISOString().slice(0,10)}.json`,d=document.createElement("a");d.setAttribute("href",t),d.setAttribute("download",n),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d)}),document.getElementById("importBtn").addEventListener("click",function(){document.getElementById("importFile").click()}),document.getElementById("importFile").addEventListener("change",function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=function(t){try{const e=JSON.parse(t.target.result);Array.isArray(e)?confirm("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")&&(a=[...a,...e],localStorage.setItem("savedRecords",JSON.stringify(a)),l()):alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞")}catch(e){alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: "+e.message)}e.target.value=""},n.readAsText(t)}),document.getElementById("clearBtn").addEventListener("click",function(){confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?")&&(a=[],localStorage.setItem("savedRecords",JSON.stringify(a)),l())});let m={key:"date",direction:"desc"};function s(e){m.key===e?m.direction="asc"===m.direction?"desc":"asc":(m.key=e,m.direction="asc"),a.sort((t,n)=>{let d=t[e],o=n[e];return"number"==typeof d&&"number"==typeof o?"asc"===m.direction?d-o:o-d:"string"==typeof d&&"string"==typeof o?"asc"===m.direction?d.localeCompare(o,"ru"):o.localeCompare(d,"ru"):0}),l(),document.querySelectorAll(".sort-btn .sort-icon").forEach(e=>{e.textContent="‚Üï"});const t=document.querySelector(`#sortBy${e.charAt(0).toUpperCase()+e.slice(1)}Btn .sort-icon`);t&&(t.textContent="asc"===m.direction?"‚Üë":"‚Üì")}function u(e){const t=parseInt(e.target.getAttribute("data-id")),n=a.find(e=>e.id===t);n&&(d=t,o.textContent="–û—Ç–º–µ–Ω–∞",r.textContent="–û–±–Ω–æ–≤–∏—Ç—å",document.getElementById("rebarName").value=n.name,document.getElementById("rebarLength").value=n.length,document.getElementById("segmentLength").value=n.segment,document.getElementById("quantity").value=n.quantity,i(),document.querySelector("#rebarForm").scrollIntoView({behavior:"smooth"}))}function g(e){const t=parseInt(e.target.getAttribute("data-id")),n=a.find(e=>e.id===t);if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å "${n.name}"?`)){const e=document.querySelector(`.record-row[data-record-id="${t}"]`);e?(e.style.transition="opacity 0.3s ease-out",e.style.opacity="0",setTimeout(()=>{a=a.filter(e=>e.id!==t),localStorage.setItem("savedRecords",JSON.stringify(a)),l()},300)):(a=a.filter(e=>e.id!==t),localStorage.setItem("savedRecords",JSON.stringify(a)),l())}}});